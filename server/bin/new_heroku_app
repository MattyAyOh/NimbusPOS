#!/bin/bash

# Make sure we're connected to the Docker host
eval $(SHELL=bash docker-machine env)

# Log into Heroku if we're not already
heroku auth:whoami || heroku login
heroku container:login

# Create our app
heroku apps:create $1

# Set production environment variables
heroku config:set --app $1 \
  RAILS_ENV=production \
  NODE_ENV=production \
  RAILS_SERVE_STATIC_FILES=true \
  SECRET_KEY_BASE=$(docker-compose run --rm web rake secret)

# Add a `postgres` database through Heroku Addons
heroku addons:create heroku-postgresql:hobby-dev --app $1

# Build and publish the app as a `web` dyno
heroku container:push web --app $1

# Start the database
heroku run --app $1 -- rake db:migrate
heroku run --app $1 -- rake db:seed
